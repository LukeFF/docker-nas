---
version: "3.8"

services:
  cloudflared:
    image: cloudflare/cloudflared:2023.8.0
    container_name: cloudflared
    restart: always
    command: tunnel --no-autoupdate run
    env_file:
      - .env

  traefik:
    image: traefik:v2.10.4
    container_name: traefik
    restart: unless-stopped
    env_file:
      - .env
    volumes:
      - /var/run/docker.sock:/car/run/docker.so:ro
    ports:
      - 80:80
      - 443:443

  teleport:
    image: public.ecr.aws/gravitational/teleport-distroless:13
    container_name: teleport
    restart: unless-stopped
    env_file:
      - .env
    volumes:
      - ${DATA}/teleport/config:/etc/teleport
      - ${DATA}/teleport/data:/var/lib/teleport
    labels:
      - "traefik.enable=true"
      - "traefik.http.services.teleport.loadbalancer.server.port=3080"
      - "traefik.http.services.teleport.loadbalancer.server.scheme=https"
      - "traefik.http.routers.teleport-http.entrypoints=web"
      - "traefik.http.routers.teleport-http.rule=HostRegexp(`${DOMAIN}`, `{subhost:[a-z]+}.${DOMAIN}`)"
      - "traefik.http.routers.teleport-https.entrypoints=websecure"
      - "traefik.http.routers.teleport-https.rule=HostRegexp(`${DOMAIN}`, `{subhost:[a-z]+}.${DOMAIN}`)"
      - "traefik.http.routers.teleport-https.tls=true"
      # - "traefik.http.routers.teleport-https.tls.certresolver=your-certresolver"
      - "traefik.http.routers.teleport-https.tls.domains[0].main=${DOMAIN}"
      - "traefik.http.routers.teleport-https.tls.domains[0].sans=*.${DOMAIN}"
